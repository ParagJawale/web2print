<variable #page [defaults]="{value:'/pages/index'}"></variable>

<!-- Updated from the injectors _onSidenavMenuClicked,_sideNav,_sidenavOpen -->
<variable #onSidenavMenuClicked></variable>
<variable #sidenavOpen></variable>

<div fxLayout="column" absolute-fill style="overflow:hidden">
	<md-toolbar style="background-color: white;border-bottom:1px solid #eeeeee;padding-left:0.25em;padding-right:0;min-height:45px;">
    	<i *ngIf="root.db.loggedIn && onSidenavMenuClicked && onSidenavMenuClicked.value" class="material-icons icon-button" style="font-size:2em;width:1em;top:9px;background-color:white;left:4px;" (click)="togg.execute()">menu</i>
    	<span fxFlex relative style="height:30px" >
    		<measure #mtoolbar [delayMilliseconds]="0">
    			<observe [events]="[mtoolbar.onReady,mtoolbar.onChange]">
    				<execution [params]="{m:mtoolbar,app:root.app}">
    					app.onToolbarPositionChanged({left:m.left,top:m.top,width:m.width,height:m.height});
    				</execution>
    			</observe>
    		</measure>
    		<!--
    		left = {{mtoolbar.left}} top={{mtoolbar.top}} > {{mtoolbar.width}}x{{mtoolbar.height}}
    		 -->
    	</span>
  		
  		<!-- TODO TODO SIMPLIFY -->
  		<!-- root.app.toggleLocked() -->  		
		<providers-menu #gridMenu walkChildContexts [providers]="[
				'grid.root.*'
		]"></providers-menu>
    	<span *ngIf="root.db.loggedIn" class="app-toolbar-user-text">{{root.db.userText}}<i *ngIf="root.storage == 'server'" class="material-icons" style="color:#CCCCCC;font-size: 22px;line-height: 12px;float: right;margin-left: 1px;margin-right:-3px;">wifi</i></span>
    	<span *ngIf="!root.db.loggedIn" class="app-toolbar-user-text">
		    <i18n>INFO_NOT_LOGGED_IN</i18n>
	    </span>

        <img md-icon-button [mdMenuTriggerFor]="langMenu" style="width:28px;height:28px;margin-top:15px;margin-right:2px;cursor:pointer" src="/images/library/flags/128/{{root.db.lang.substring(root.db.lang.indexOf('-')+1).toLowerCase()}}.png"></img>
  		<i *ngIf="root.db.loggedIn" class="material-icons icon-button" style="font-size:35px;margin-top:15px;width:32px;overflow:hidden;margin-left:-3px;" [mdMenuTriggerFor]="settingsMenu">person</i>

        
    	<query schema="core.lang" properties="code,NAME" where="is_active=1">
	      	<result #langs>
		        <md-menu #langMenu>
	          		<button *ngFor="let lang of langs.objects" md-menu-item (click)="root.app.changeLanguage(lang.code)">
			            <md-icon>
	    	          		<img style="width:32px;height:32px;margin-top:-4px;margin-left:-4px" src="/images/library/flags/128/{{lang.code.substring(lang.code.indexOf('-')+1).toLowerCase()}}.png">
	        	      		</img>
	            		</md-icon>
	            		<span>{{lang.NAME}}</span>
	          		</button>
	        	</md-menu>
	      	</result>
    	</query>
    	<md-menu #settingsMenu>
	      	<button disabled md-menu-item (click)="root.app.openSettings()">
		        <md-icon>settings</md-icon>
        		<i18n>LABEL_SETTINGS</i18n>
	      	</button>
	      	<button md-menu-item (click)="root.app.logout()">
		        <md-icon>lock_outline</md-icon>
	        	<i18n>INFO_LOGOUT</i18n>
	      	</button>
	    </md-menu>
  	</md-toolbar>
  	<md-divider md-inset></md-divider>
	<!-- MAIN CONTENT IF LOGGED IN -->
	<div fxFlex relative>
		<md-progress-bar [style.opacity]="0.35" [style.z-index]="15" color="accent" [style.visibility]="root.app.loading ? 'visible' : 'hidden'" [value]="root.app.progress" [mode]="root.app.loading ? (root.app.progress != undefined ? 'determinate' : 'query') : 'determinate'"></md-progress-bar>

	    <ng-template let-route let-index ngFor [ngForOf]="root.app.routes" >
	    	<!-- *ngIf="route === root.app.route" -->
			<!--
			<attach ref="/pages/{{route.path}}" fallback="/pages/not-found" path="{{route.path}}" class="main-layout-attach-content" [params]="route.params" [class.main-path-container-hidden]="route !== root.app.route" [paused]="route !== root.app.route">
			-->
 
			<attach class="main-layout-attach-content grid-fullscreen-container" [shareProviders]="route === root.app.route" *ngIf="route === root.app.route || root.app.routes[index+1] === route || route.path == 'embed'" ref="/pages/{{route.path}}" fallback="/pages/not-found" path="{{route.path}}" [params]="route.params" [class.main-path-container-hidden]="route !== root.app.route" [paused]="route !== root.app.route">
				<inject #_onSidenavMenuClicked var="onSidenavMenuClicked"><observe [execution]="update"></observe></inject>
				<inject #_sidenavOpen var="sidenavOpen"><observe [execution]="update"></observe></inject>
				<execution #update [params]="{route:route,app:root.app,onSidenavMenuClicked:onSidenavMenuClicked,sidenavOpen:sidenavOpen,_onSidenavMenuClicked:_onSidenavMenuClicked,_sidenavOpen:_sidenavOpen}"><![CDATA[
					var changes = args[0];
					if (route !== app.route)
						return;
					if (changes && !changes.value)
						return;
					onSidenavMenuClicked.value=_onSidenavMenuClicked.value;
					sidenavOpen.value=_sidenavOpen.value;
				]]></execution>
				<observe [event]="root.app.onNavigation">
					<execution [params]="{onSidenavMenuClicked:onSidenavMenuClicked,sidenavOpen:sidenavOpen,root:root,update:update}"><![CDATA[
						onSidenavMenuClicked.value=undefined;
						sidenavOpen.value=undefined;
						root.setTimeout(function() {
							update.execute();
						},0);
					]]></execution>
				</observe>
			</attach>
        </ng-template>

		<!--

		<attach ref="/pages/energy_management/default" class="main-layout-attach-content">
			<inject #onSidenavMenuClicked var="onSidenavMenuClicked"></inject>
			<inject #sidenav var="sidenav"></inject>
			<inject #sidenavOpen var="sidenavOpen"></inject>
		</attach>
		 -->
	</div>
</div>
<execution #togg [params]="{onSidenavMenuClicked:onSidenavMenuClicked,sidenavOpen:sidenavOpen}">
  if (document.getElementById('sn').style.display == 'none') {
    document.getElementById('sn').style.display = 'block';
    if (!sidenavOpen.value) {
      onSidenavMenuClicked.value();
    }
  } else {
    onSidenavMenuClicked.value();
  }
</execution>
